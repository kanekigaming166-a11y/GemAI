<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GemAI</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        :root {
            --gem-bg: #131314;
            --gem-sidebar: #1e1f20;
            --gem-hover: #333537;
            --gem-blue: #4b90ff;
        }
        body { background-color: var(--gem-bg); color: #e3e3e3; font-family: 'Segoe UI', sans-serif; }
        .sidebar { background-color: var(--gem-sidebar); width: 280px; transition: 0.3s ease; }
        
        .chat-msg { max-width: 800px; margin: 0 auto; padding: 20px; }
        .user-msg { background: transparent; }
        .ai-msg { background: transparent; }
        
        .input-pill {
            background-color: #1e1f20;
            border-radius: 32px;
            border: 1px solid transparent;
            transition: 0.2s;
            max-width: 850px;
            margin: 0 auto;
        }
        .input-pill:focus-within { border-color: #4b90ff; background-color: #28292a; }
        
        pre { background: #000 !important; padding: 15px; border-radius: 12px; margin: 10px 0; }
        .prose code { color: #8ab4f8; }

        /* Editing Animation */
        .edit-input { background: #333; border: none; color: white; border-radius: 4px; padding: 2px 5px; width: 80%; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside id="sidebar" class="sidebar flex flex-col z-50 fixed inset-y-0 left-0 -translate-x-full lg:translate-x-0 lg:relative">
        <div class="p-4 flex items-center gap-3">
            <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-700 rounded-full">‚ò∞</button>
            <span class="font-bold text-xl text-blue-400">GemAI</span>
        </div>

        <button onclick="createNewChat()" class="mx-4 mt-4 mb-6 flex items-center gap-3 bg-[#1a1c1e] hover:bg-gray-700 p-3 rounded-full text-sm font-medium transition-all">
            <span class="text-xl">+</span> New Chat
        </button>

        <div class="px-4 text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wider">Recent</div>
        <div id="chat-list" class="flex-1 overflow-y-auto px-2 space-y-1"></div>

        <div class="p-4 border-t border-gray-800 space-y-2">
            <button onclick="openSettings()" class="w-full text-left p-2 hover:bg-gray-800 rounded-lg text-sm flex items-center gap-3">‚öôÔ∏è Settings</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative h-full overflow-hidden">
        
        <header class="p-4 flex justify-between items-center lg:hidden">
            <button onclick="toggleSidebar()" class="text-2xl">‚ò∞</button>
            <div class="font-bold text-blue-400">GemAI</div>
            <div class="w-8"></div>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto pb-40 scroll-smooth">
            <div id="empty-state" class="h-full flex flex-col items-center justify-center p-6 mt-20">
                <h1 class="text-5xl font-medium mb-8 bg-gradient-to-r from-blue-400 via-purple-400 to-red-400 bg-clip-text text-transparent">Hello, User</h1>
                <p class="text-gray-400 text-lg">How can I help you with your tasks today?</p>
            </div>
        </div>

        <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-[#131314] via-[#131314] to-transparent">
            <div class="input-pill flex items-end p-2 px-4 shadow-2xl">
                <button onclick="toggleVoiceInput()" id="mic-btn" class="p-3 text-gray-400 hover:text-white transition-colors">üé§</button>
                <textarea id="user-input" rows="1" 
                    class="flex-1 bg-transparent border-none focus:ring-0 text-white p-3 max-h-52 resize-none outline-none"
                    placeholder="Enter a prompt here..."
                    oninput="autoResize(this)"
                    onkeydown="handleEnter(event)"></textarea>
                <button id="send-btn" onclick="sendMessage()" class="p-3 text-blue-400 hover:text-blue-300 disabled:opacity-30">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
            <div class="text-[11px] text-gray-500 text-center mt-3">GemAI may display inaccurate info. Verify its responses.</div>
        </div>
    </main>

    <dialog id="settings-modal" class="bg-[#1e1f20] text-gray-200 p-6 rounded-2xl w-full max-w-sm border border-gray-700 m-auto backdrop:backdrop-blur-sm">
        <h3 class="text-xl font-bold mb-4">Settings</h3>
        <input type="password" id="api-key" placeholder="OpenRouter API Key" class="w-full p-3 bg-black rounded-lg mb-4 outline-none border border-gray-700">
        <input type="text" id="model-id" value="google/gemini-2.0-flash-lite-preview-02-05:free" class="w-full p-3 bg-black rounded-lg mb-4 outline-none border border-gray-700">
        <button onclick="saveSettings()" class="w-full py-3 bg-blue-600 rounded-full font-bold">Save Changes</button>
    </dialog>

    <script>
        let state = {
            apiKey: localStorage.getItem('chat_api_key') || '',
            chatModel: localStorage.getItem('chat_model') || 'google/gemini-2.0-flash-lite-preview-02-05:free',
            chats: JSON.parse(localStorage.getItem('chat_history') || '{}'),
            activeChatId: null
        };

        let synth = window.speechSynthesis;
        let recognition;

        document.addEventListener('DOMContentLoaded', () => {
            renderSidebar();
            const ids = Object.keys(state.chats).sort((a,b) => state.chats[b].timestamp - state.chats[a].timestamp);
            if (ids.length > 0) loadChat(ids[0]);
            else createNewChat(false);
            if (!state.apiKey) openSettings();
        });

        function generateId() { return Math.random().toString(36).substr(2, 9); }
        function saveChats() { localStorage.setItem('chat_history', JSON.stringify(state.chats)); }

        function createNewChat(activate = true) {
            const id = generateId();
            state.chats[id] = { id, title: 'New Chat', messages: [], timestamp: Date.now() };
            saveChats(); renderSidebar();
            if (activate) loadChat(id);
        }

        function renderSidebar() {
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            Object.values(state.chats).sort((a,b) => b.timestamp - a.timestamp).forEach(chat => {
                const div = document.createElement('div');
                div.className = `group flex items-center justify-between p-2 rounded-full cursor-pointer hover:bg-gray-800 ${state.activeChatId === chat.id ? 'bg-[#333537]' : ''}`;
                div.onclick = () => loadChat(chat.id);
                
                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <span class="text-sm">üí¨</span>
                        <span id="title-${chat.id}" class="text-sm truncate w-40">${chat.title}</span>
                    </div>
                    <div class="hidden group-hover:flex gap-1 pr-2">
                        <button onclick="event.stopPropagation(); editName('${chat.id}')" class="text-xs hover:text-white">‚úèÔ∏è</button>
                        <button onclick="event.stopPropagation(); deleteChat('${chat.id}')" class="text-xs hover:text-red-400">‚úï</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function editName(id) {
            const span = document.getElementById(`title-${id}`);
            const oldName = span.innerText;
            const input = document.createElement('input');
            input.className = "edit-input";
            input.value = oldName;
            span.innerHTML = '';
            span.appendChild(input);
            input.focus();
            input.onclick = (e) => e.stopPropagation();
            input.onblur = () => {
                const newName = input.value.trim() || oldName;
                state.chats[id].title = newName;
                saveChats(); renderSidebar();
            };
            input.onkeydown = (e) => { if(e.key === 'Enter') input.blur(); };
        }

        function loadChat(id) {
            state.activeChatId = id;
            document.getElementById('empty-state').style.display = state.chats[id].messages.length ? 'none' : 'flex';
            const container = document.getElementById('chat-container');
            container.innerHTML = '';
            state.chats[id].messages.forEach(msg => appendMessage(msg));
            renderSidebar();
            container.scrollTop = container.scrollHeight;
        }

        function appendMessage(msg) {
            const container = document.getElementById('chat-container');
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-msg animate-fade-in ${msg.role === 'user' ? 'user-msg' : 'ai-msg'}`;
            
            const inner = document.createElement('div');
            inner.className = "flex gap-4";
            
            const icon = `<div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-bold ${msg.role === 'user' ? 'bg-blue-600' : 'bg-gradient-to-tr from-blue-500 to-red-400'}">${msg.role === 'user' ? 'U' : 'G'}</div>`;
            
            const textContent = document.createElement('div');
            textContent.className = "prose prose-invert flex-1";
            
            if(msg.type === 'image') {
                textContent.innerHTML = `<img src="${msg.content}" class="rounded-2xl max-w-full lg:max-w-md shadow-2xl border border-gray-800" />`;
            } else {
                textContent.innerHTML = DOMPurify.sanitize(marked.parse(msg.content));
                textContent.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
            }

            inner.innerHTML = icon;
            inner.appendChild(textContent);
            msgDiv.appendChild(inner);

            // Action Buttons for AI
            if(msg.role === 'assistant') {
                const actions = document.createElement('div');
                actions.className = "flex gap-4 mt-4 ml-12 opacity-50 hover:opacity-100 transition-opacity";
                actions.innerHTML = `
                    <button onclick="copyMsg(this, \`${msg.content.replace(/`/g, '\\`')}\`)" class="text-xs hover:text-blue-400">Copy</button>
                    <button onclick="readText(\`${msg.content.replace(/`/g, '\\`')}\`)" class="text-xs hover:text-blue-400">Listen</button>
                `;
                msgDiv.appendChild(actions);
            }

            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text || !state.apiKey) return;
            input.value = ''; input.style.height = 'auto';
            document.getElementById('empty-state').style.display = 'none';

            const userMsg = { role: 'user', content: text };
            state.chats[state.activeChatId].messages.push(userMsg);
            if (state.chats[state.activeChatId].messages.length === 1) state.chats[state.activeChatId].title = text.slice(0, 30);
            
            appendMessage(userMsg);
            saveChats();

            const loader = document.createElement('div');
            loader.className = "chat-msg opacity-50 italic animate-pulse ml-12";
            loader.innerText = "GemAI is thinking...";
            document.getElementById('chat-container').appendChild(loader);

            try {
                const isImg = text.toLowerCase().includes("image") || text.toLowerCase().includes("generate");
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${state.apiKey}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: isImg ? "openai/dall-e-3" : state.chatModel,
                        messages: state.chats[state.activeChatId].messages
                    })
                });
                const data = await response.json();
                loader.remove();
                const aiMsg = { role: 'assistant', content: data.choices[0].message.content, type: isImg ? 'image' : 'text' };
                state.chats[state.activeChatId].messages.push(aiMsg);
                appendMessage(aiMsg);
                saveChats(); renderSidebar();
            } catch(e) { loader.remove(); alert(e.message); }
        }

        function openSettings() { document.getElementById('settings-modal').showModal(); document.getElementById('api-key').value = state.apiKey; }
        function saveSettings() {
            state.apiKey = document.getElementById('api-key').value;
            state.chatModel = document.getElementById('model-id').value;
            localStorage.setItem('chat_api_key', state.apiKey);
            localStorage.setItem('chat_model', state.chatModel);
            document.getElementById('settings-modal').close();
        }

        function deleteChat(id) { if(confirm('Delete?')){ delete state.chats[id]; saveChats(); createNewChat(); } }
        function copyMsg(btn, txt) { navigator.clipboard.writeText(txt); btn.innerText = "Copied!"; setTimeout(()=>btn.innerText="Copy", 2000); }
        function readText(txt) { if(synth.speaking) synth.cancel(); else synth.speak(new SpeechSynthesisUtterance(txt)); }
        function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
        function handleEnter(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
        
        function toggleVoiceInput() {
            if (!recognition) {
                recognition = new webkitSpeechRecognition();
                recognition.onstart = () => { document.getElementById('mic-btn').innerText = "üî¥"; };
                recognition.onresult = (e) => { document.getElementById('user-input').value = e.results[0][0].transcript; };
                recognition.onend = () => { document.getElementById('mic-btn').innerText = "üé§"; sendMessage(); };
            }
            recognition.start();
        }
    </script>
</body>
    </html>
