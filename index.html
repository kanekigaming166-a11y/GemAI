<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile AI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); }
        body { background-color: #05070a; color: #e5e7eb; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; }
    </style>
</head>
<body>

    <header class="p-4 border-b border-gray-800 flex justify-between items-center bg-[#0d1117]">
        <h1 class="font-bold text-blue-500">GLM Mobile Test</h1>
        <button onclick="toggleSettings()" class="text-xs bg-gray-800 px-3 py-1 rounded-full">Settings ⚙️</button>
    </header>

    <div id="settings-panel" class="hidden p-4 bg-[#0d1117] border-b border-gray-800 space-y-3">
        <input type="password" id="key-input" placeholder="Paste OpenRouter Key" class="w-full p-3 rounded bg-gray-900 border border-gray-700 text-sm">
        <input type="text" id="model-input" value="z-ai/glm-4.5-air:free" class="w-full p-3 rounded bg-gray-900 border border-gray-700 text-sm">
        <p class="text-[10px] text-gray-500 text-center italic">Key is saved in your phone's browser.</p>
    </div>

    <div id="error-display" class="hidden m-3 p-3 bg-red-900/40 border border-red-500 text-red-200 text-xs rounded-lg"></div>

    <div id="chat-window" class="space-y-4">
        <div class="bg-blue-900/20 p-3 rounded-lg text-sm border border-blue-800/30 text-blue-200">
            <strong>System:</strong> Phone interface ready. Make sure your API key is correct.
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 p-3 bg-[#05070a] border-t border-gray-800">
        <div class="flex gap-2">
            <input type="text" id="user-msg" placeholder="Type here..." class="flex-1 bg-gray-900 p-3 rounded-xl border border-gray-700 focus:outline-none focus:border-blue-500">
            <button onclick="send()" id="send-btn" class="bg-blue-600 px-5 py-3 rounded-xl font-bold">➤</button>
        </div>
    </div>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const errorDisplay = document.getElementById('error-display');
        const keyInput = document.getElementById('key-input');
        const modelInput = document.getElementById('model-input');
        const userMsg = document.getElementById('user-msg');
        const sendBtn = document.getElementById('send-btn');

        // Load data from phone's memory
        keyInput.value = localStorage.getItem('phone_key') || '';
        modelInput.value = localStorage.getItem('phone_model') || 'z-ai/glm-4.5-air:free';

        function toggleSettings() {
            document.getElementById('settings-panel').classList.toggle('hidden');
        }

        async function send() {
            const key = keyInput.value.trim();
            const model = modelInput.value.trim();
            const text = userMsg.value.trim();

            if (!key) { alert("Please enter API Key!"); toggleSettings(); return; }
            if (!text) return;

            // Save key
            localStorage.setItem('phone_key', key);
            localStorage.setItem('phone_model', model);

            // UI Update
            errorDisplay.classList.add('hidden');
            addMessage("You", text);
            userMsg.value = "";
            sendBtn.disabled = true;
            sendBtn.innerText = "..";

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${key}`,
                        "Content-Type": "application/json",
                        "X-Title": "MobileChat"
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{role: "user", content: text}]
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error?.message || "Connection Error");
                }

                addMessage("AI", data.choices[0].message.content);

            } catch (err) {
                errorDisplay.innerText = "Error: " + err.message;
                errorDisplay.classList.remove('hidden');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerText = "➤";
            }
        }

        function addMessage(sender, text) {
            const div = document.createElement('div');
            div.className = sender === "AI" ? "bg-gray-900 p-3 rounded-lg text-sm border border-gray-800" : "bg-blue-700/20 p-3 rounded-lg text-sm border border-blue-700/30 ml-8 text-right";
            div.innerHTML = `<div class="font-bold text-xs text-gray-500 mb-1">${sender}</div><div>${marked.parse(text)}</div>`;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    </script>
</body>
</html>
