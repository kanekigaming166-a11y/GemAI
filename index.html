<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GemAI</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* ChatGPT Colors */
        :root {
            --bg-dark: #212121;
            --sidebar-dark: #171717;
            --user-bubble: #2f2f2f;
        }
        .dark body { background-color: var(--bg-dark); }
        .sidebar { background-color: var(--sidebar-dark); }
        
        /* Typography */
        .prose { max-width: 100% !important; font-size: 16px; line-height: 1.6; }
        pre { background: #0d0d0d !important; border-radius: 8px; border: 1px solid #333; }
        
        /* Message Layout */
        .message-container { max-width: 768px; margin: 0 auto; width: 100%; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #424242; border-radius: 10px; }
        
        /* Input Box style like GPT */
        .input-wrapper {
            background-color: #2f2f2f;
            border: 1px solid #424242;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        .dark .input-wrapper { background-color: #2f2f2f; }
        
        /* Animations */
        .dot-flashing { position: relative; width: 6px; height: 6px; border-radius: 5px; background-color: #fff; animation: dot-flashing 1s infinite linear alternate; animation-delay: .5s; }
        .dot-flashing::before, .dot-flashing::after { content: ''; display: inline-block; position: absolute; top: 0; width: 6px; height: 6px; border-radius: 5px; background-color: #fff; animation: dot-flashing 1s infinite alternate; }
        .dot-flashing::before { left: -12px; animation-delay: 0s; }
        .dot-flashing::after { left: 12px; animation-delay: 1s; }
        @keyframes dot-flashing { 0% { background-color: #fff; } 50%, 100% { background-color: #555; } }
    </style>
</head>
<body class="text-gray-200 h-[100dvh] flex overflow-hidden">

    <aside id="sidebar" class="sidebar w-64 flex-shrink-0 flex flex-col hidden md:flex transition-all duration-300">
        <div class="p-3">
            <button onclick="createNewChat()" class="w-full flex items-center gap-3 px-3 py-3 text-sm font-medium border border-gray-600 rounded-lg hover:bg-gray-800 transition-all">
                <span class="text-lg">+</span> New Chat
            </button>
        </div>
        <div id="chat-list" class="flex-1 overflow-y-auto px-3 space-y-1"></div>
        <div class="p-3 border-t border-gray-800">
            <button onclick="openSettings()" class="w-full flex items-center gap-3 p-3 text-sm hover:bg-gray-800 rounded-lg">‚öôÔ∏è Settings</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative h-full overflow-hidden">
        
        <header class="flex items-center justify-between p-3 border-b border-gray-800 md:border-none">
            <button onclick="toggleSidebar()" class="md:hidden text-gray-400 p-2 text-xl">‚ò∞</button>
            <div class="font-semibold text-gray-300">GemAI <span class="text-xs bg-gray-800 px-2 py-0.5 rounded text-gray-500 ml-1">4o</span></div>
            <div class="w-8"></div>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto pt-4 pb-48 px-4 scroll-smooth">
            <div id="empty-state" class="h-full flex flex-col items-center justify-center text-center">
                <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center mb-4">
                    <span class="text-black font-bold text-2xl">G</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-100">How can I help you today?</h2>
            </div>
        </div>

        <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-[#212121] via-[#212121] to-transparent">
            <div class="message-container">
                <div class="input-wrapper relative rounded-2xl flex items-end p-2 px-3">
                    <button onclick="toggleVoiceInput()" id="mic-btn" class="p-2 text-gray-400 hover:text-white transition-colors">üé§</button>
                    <textarea id="user-input" rows="1" 
                        class="flex-1 bg-transparent border-none focus:ring-0 text-white p-2 max-h-52 resize-none outline-none overflow-y-auto"
                        placeholder="Message GemAI..."
                        oninput="autoResize(this)"
                        onkeydown="handleEnter(event)"></textarea>
                    <button id="send-btn" onclick="sendMessage()" class="bg-white text-black p-2 rounded-xl mb-1 ml-2 transition-all hover:bg-gray-200 disabled:bg-gray-600">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 11L12 6L17 11M12 18V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </button>
                </div>
                <p class="text-[11px] text-gray-500 text-center mt-2">GemAI can make mistakes. Check important info.</p>
            </div>
        </div>
    </main>

    <dialog id="settings-modal" class="bg-[#2f2f2f] text-gray-100 rounded-xl shadow-2xl p-6 w-full max-w-md backdrop:backdrop-blur-sm m-auto border border-gray-700">
        <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-2">
            <h3 class="text-lg font-bold">Settings</h3>
            <button onclick="document.getElementById('settings-modal').close()" class="text-gray-400">‚úï</button>
        </div>
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">API Key</label>
                <input type="password" id="api-key" class="w-full p-2 bg-[#171717] border border-gray-700 rounded text-sm outline-none focus:border-white">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Chat Model</label>
                <input type="text" id="model-id" value="google/gemini-2.0-flash-lite-preview-02-05:free" class="w-full p-2 bg-[#171717] border border-gray-700 rounded text-sm outline-none">
            </div>
            <button onclick="saveSettings()" class="w-full py-2 bg-white text-black rounded font-bold mt-4">Save</button>
        </div>
    </dialog>

    <script>
        // --- Core JS ---
        let state = {
            apiKey: localStorage.getItem('chat_api_key') || '',
            chatModel: localStorage.getItem('chat_model') || 'google/gemini-2.0-flash-lite-preview-02-05:free',
            chats: JSON.parse(localStorage.getItem('chat_history') || '{}'),
            activeChatId: null
        };

        let recognition;
        let synth = window.speechSynthesis;

        document.addEventListener('DOMContentLoaded', () => {
            renderSidebar();
            const ids = Object.keys(state.chats).sort((a,b) => state.chats[b].timestamp - state.chats[a].timestamp);
            if (ids.length > 0) loadChat(ids[0]);
            else createNewChat(false);
            if (!state.apiKey) openSettings();
        });

        function generateId() { return Math.random().toString(36).substr(2, 9); }
        function saveChats() { localStorage.setItem('chat_history', JSON.stringify(state.chats)); }

        function createNewChat(activate = true) {
            const id = generateId();
            state.chats[id] = { id, title: 'New Chat', messages: [], timestamp: Date.now() };
            saveChats();
            renderSidebar();
            if (activate) loadChat(id);
        }

        function loadChat(id) {
            state.activeChatId = id;
            document.getElementById('empty-state').style.display = state.chats[id].messages.length ? 'none' : 'flex';
            const container = document.getElementById('chat-container');
            container.innerHTML = '';
            state.chats[id].messages.forEach(msg => appendMessage(msg));
            container.scrollTop = container.scrollHeight;
        }

        function renderSidebar() {
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            Object.values(state.chats).sort((a,b) => b.timestamp - a.timestamp).forEach(chat => {
                const btn = document.createElement('div');
                btn.className = `p-2 text-sm text-gray-300 truncate rounded-lg cursor-pointer hover:bg-gray-800 mb-1 ${state.activeChatId === chat.id ? 'bg-gray-800' : ''}`;
                btn.onclick = () => loadChat(chat.id);
                btn.innerText = chat.title;
                list.appendChild(btn);
            });
        }

        function appendMessage(msg) {
            const container = document.getElementById('chat-container');
            const wrapper = document.createElement('div');
            wrapper.className = `py-6 ${msg.role === 'assistant' ? 'bg-transparent' : 'flex justify-end'}`;
            
            const content = document.createElement('div');
            content.className = `message-container flex gap-4 ${msg.role === 'user' ? 'bg-[#2f2f2f] rounded-2xl px-4 py-2 w-fit' : ''}`;
            
            const textDiv = document.createElement('div');
            textDiv.className = "prose prose-invert prose-sm text-gray-200";
            
            if (msg.type === 'image') {
                textDiv.innerHTML = `<img src="${msg.content}" class="rounded-lg max-w-sm mt-2 shadow-xl border border-gray-700" />`;
            } else {
                textDiv.innerHTML = DOMPurify.sanitize(marked.parse(msg.content));
                textDiv.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
            }

            // Speak Button for AI
            if (msg.role === 'assistant') {
                const spkBtn = document.createElement('button');
                spkBtn.innerHTML = "üîä";
                spkBtn.className = "text-xs opacity-30 hover:opacity-100 ml-auto block";
                spkBtn.onclick = () => readText(msg.content);
                content.appendChild(textDiv);
                content.appendChild(spkBtn);
            } else {
                content.appendChild(textDiv);
            }

            wrapper.appendChild(content);
            container.appendChild(wrapper);
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text || !state.apiKey) return;

            input.value = '';
            input.style.height = 'auto';
            document.getElementById('empty-state').style.display = 'none';

            const userMsg = { role: 'user', content: text };
            state.chats[state.activeChatId].messages.push(userMsg);
            if (state.chats[state.activeChatId].messages.length === 1) state.chats[state.activeChatId].title = text.slice(0, 20);
            
            appendMessage(userMsg);
            saveChats();

            // Loading Indicator
            const loader = document.createElement('div');
            loader.className = "message-container py-8 flex gap-4 items-center";
            loader.innerHTML = `<div class="dot-flashing ml-4"></div>`;
            document.getElementById('chat-container').appendChild(loader);

            try {
                const isImage = text.toLowerCase().includes("image") || text.toLowerCase().includes("generate");
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${state.apiKey}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: isImage ? "openai/dall-e-3" : state.chatModel,
                        messages: state.chats[state.activeChatId].messages
                    })
                });

                const data = await response.json();
                loader.remove();

                const aiContent = data.choices[0].message.content;
                const msgObj = { role: 'assistant', content: aiContent, type: isImage ? 'image' : 'text' };
                state.chats[state.activeChatId].messages.push(msgObj);
                appendMessage(msgObj);
                saveChats();
                renderSidebar();
            } catch (err) {
                loader.remove();
                alert("Error: " + err.message);
            }
        }

        function openSettings() { document.getElementById('settings-modal').showModal(); document.getElementById('api-key').value = state.apiKey; }
        function saveSettings() {
            state.apiKey = document.getElementById('api-key').value;
            state.chatModel = document.getElementById('model-id').value;
            localStorage.setItem('chat_api_key', state.apiKey);
            localStorage.setItem('chat_model', state.chatModel);
            document.getElementById('settings-modal').close();
        }

        function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
        function handleEnter(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); }
        function readText(txt) { if(synth.speaking) synth.cancel(); else synth.speak(new SpeechSynthesisUtterance(txt)); }
        function toggleVoiceInput() {
            if (!recognition) {
                recognition = new webkitSpeechRecognition();
                recognition.onstart = () => { document.getElementById('mic-btn').innerText = "üî¥"; };
                recognition.onresult = (e) => { document.getElementById('user-input').value = e.results[0][0].transcript; };
                recognition.onend = () => { document.getElementById('mic-btn').innerText = "üé§"; sendMessage(); };
            }
            recognition.start();
        }
    </script>
</body>
</html>
